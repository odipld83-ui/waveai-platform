{% extends "base.html" %}

{% block title %}{{ agent.name }} - WaveAI{% endblock %}

{% block body_class %}agent-page agent-{{ agent_id }}{% endblock %}

{% block content %}
<section class="agent-interface">
    <!-- Header de l'agent -->
    <div class="agent-header-section" style="background: linear-gradient(135deg, {{ agent.color }}, {{ agent.color }}99)">
        <div class="container">
            <div class="row align-items-center py-4">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <div class="agent-avatar-xl me-4">{{ agent.icon }}</div>
                        <div class="agent-header-info">
                            <h1 class="agent-title text-white mb-2">{{ agent.name }}</h1>
                            <p class="agent-tagline text-white-50 mb-3">{{ agent.title }}</p>
                            <div class="agent-status-badge">
                                <span class="badge bg-success">
                                    <i class="fas fa-circle pulse"></i> En ligne
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="agent-actions">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light me-2">
                            <i class="fas fa-arrow-left me-2"></i>Retour
                        </a>
                        <button class="btn btn-light" onclick="clearChat()">
                            <i class="fas fa-broom me-2"></i>Nouveau Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface de chat -->
    <div class="chat-container">
        <div class="container-fluid h-100">
            <div class="row h-100">
                <!-- Sidebar avec infos agent -->
                <div class="col-xl-3 d-none d-xl-block">
                    <div class="agent-sidebar">
                        <div class="agent-card">
                            <div class="agent-card-header">
                                <div class="agent-avatar-lg mb-3">{{ agent.icon }}</div>
                                <h5>{{ agent.name }}</h5>
                                <p class="text-muted">{{ agent.description }}</p>
                            </div>

                            <div class="agent-features-list">
                                <h6 class="mb-3">Sp√©cialit√©s :</h6>
                                {% for feature in agent.features %}
                                <div class="feature-item mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    {{ feature }}
                                </div>
                                {% endfor %}
                            </div>

                            <div class="agent-tips mt-4">
                                <h6 class="mb-3">üí° Conseils :</h6>
                                <div class="tip-item">
                                    <small class="text-muted">
                                        {% if agent_id == 'alex' %}
                                        Demandez-moi d'organiser vos emails par priorit√© ou de cr√©er des r√©ponses automatiques.
                                        {% elif agent_id == 'lina' %}
                                        Je peux vous aider √† r√©diger des messages LinkedIn personnalis√©s et analyser votre r√©seau.
                                        {% elif agent_id == 'marco' %}
                                        Confiez-moi la planification de vos posts et l'analyse de vos performances sociales.
                                        {% elif agent_id == 'sofia' %}
                                        Laissez-moi optimiser votre emploi du temps et synchroniser vos calendriers.
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Zone de chat principale -->
                <div class="col-xl-9">
                    <div class="chat-main-area">
                        <!-- Messages container -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="welcome-message">
                                <div class="welcome-avatar">{{ agent.icon }}</div>
                                <div class="welcome-content">
                                    <h4>Bonjour {{ user.name }} ! üëã</h4>
                                    <p>Je suis <strong>{{ agent.name }}</strong>, votre {{ agent.title.lower() }}.</p>
                                    <p>{{ agent.description }}</p>
                                    <div class="welcome-suggestions">
                                        <p class="mb-2"><small class="text-muted">Suggestions pour commencer :</small></p>
                                        {% if agent_id == 'alex' %}
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Aide-moi √† organiser ma bo√Æte email')">
                                            üìß Organiser emails
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Cr√©e des r√©ponses automatiques pour mes emails fr√©quents')">
                                            ü§ñ R√©ponses auto
                                        </button>
                                        {% elif agent_id == 'lina' %}
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Analyse mon r√©seau LinkedIn')">
                                            üìä Analyser r√©seau
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('√âcris un message LinkedIn personnalis√©')">
                                            üí¨ Message perso
                                        </button>
                                        {% elif agent_id == 'marco' %}
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Planifie mes posts sur les r√©seaux sociaux')">
                                            üìÖ Planifier posts
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Analyse les tendances actuelles')">
                                            üî• Tendances
                                        </button>
                                        {% elif agent_id == 'sofia' %}
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Optimise mon planning de la semaine')">
                                            üóìÔ∏è Optimiser planning
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="sendSuggestion('Synchronise mes calendriers')">
                                            üîÑ Sync calendriers
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Input zone -->
                        <div class="chat-input-area">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="messageInput" 
                                       placeholder="Tapez votre message √† {{ agent.name }}..."
                                       maxlength="500">
                                <button class="btn btn-primary" type="button" id="sendButton" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="input-info">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Appuyez sur Entr√©e pour envoyer ‚Ä¢ <span id="charCount">0</span>/500 caract√®res
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Configuration SocketIO
const socket = io();
const agentId = '{{ agent_id }}';
const agentName = '{{ agent.name }}';

// Gestion des messages
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Compteur de caract√®res
document.getElementById('messageInput').addEventListener('input', function(e) {
    const count = e.target.value.length;
    document.getElementById('charCount').textContent = count;

    if (count > 450) {
        document.getElementById('charCount').className = 'text-warning';
    } else if (count > 480) {
        document.getElementById('charCount').className = 'text-danger';
    } else {
        document.getElementById('charCount').className = 'text-muted';
    }
});

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    // Afficher le message utilisateur
    addMessageToChat('user', message);

    // Vider l'input
    input.value = '';
    document.getElementById('charCount').textContent = '0';

    // Envoyer au serveur
    socket.emit('agent_message', {
        agent_id: agentId,
        message: message
    });

    // Afficher indicateur de frappe
    showTypingIndicator();
}

function sendSuggestion(message) {
    document.getElementById('messageInput').value = message;
    sendMessage();
}

function addMessageToChat(sender, message, timestamp = null) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}-message`;

    const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content user-content">
                <div class="message-text">${escapeHtml(message)}</div>
                <div class="message-time">${time}</div>
            </div>
            <div class="message-avatar user-avatar">
                <i class="fas fa-user"></i>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar agent-avatar">{{ agent.icon }}</div>
            <div class="message-content agent-content">
                <div class="message-text">${escapeHtml(message)}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
    }

    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message agent-message typing-indicator';
    typingDiv.id = 'typingIndicator';

    typingDiv.innerHTML = `
        <div class="message-avatar agent-avatar">{{ agent.icon }}</div>
        <div class="message-content agent-content">
            <div class="typing-animation">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;

    chatMessages.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    const welcomeMessage = chatMessages.querySelector('.welcome-message');
    chatMessages.innerHTML = '';
    if (welcomeMessage) {
        chatMessages.appendChild(welcomeMessage);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Gestion des r√©ponses SocketIO
socket.on('agent_response', function(data) {
    hideTypingIndicator();
    addMessageToChat('agent', data.message, data.timestamp);
});

socket.on('error', function(data) {
    hideTypingIndicator();
    addMessageToChat('agent', `‚ùå Erreur: ${data.message}`);
});

// Auto-focus sur l'input
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('messageInput').focus();
});
</script>
{% endblock %}